<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout - MMU Bike Rental</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="app.js" defer></script>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: linear-gradient(135deg, #e9eafc 0%, #f7f7fa 100%);
      margin: 0;
      color: #222;
    }
    header {
      background: #5b0be5;
      color: #fff;
      padding: 18px 0;
      text-align: center;
      font-size: 1.2em;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px rgba(91,11,229,0.08);
    }
    header a {
      color: #fff;
      text-decoration: none;
      margin: 0 18px;
      font-weight: bold;
      transition: color 0.2s;
    }
    header a:hover {
      color: #ffeeba;
    }
    main {
      max-width: 900px;
      margin: 30px auto;
      padding: 24px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(91,11,229,0.07);
    }
    h1 {
      color: #5b0be5;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.2em;
      font-weight: 700;
    }
    .checkout-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 28px;
      margin-bottom: 40px;
    }
    .bike-summary {
      background: #f7f7fa;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 12px rgba(91,11,229,0.06);
    }
    .bike-summary h2 {
      color: #5b0be5;
      margin-top: 0;
      font-size: 1.3em;
    }
    .bike-image img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(91,11,229,0.07);
    }
    .bike-details p {
      margin: 8px 0;
      color: #666;
    }
    .bike-price {
      font-weight: bold;
      color: #5b0be5;
      margin-top: 14px;
      font-size: 1.2em;
    }
    .rental-form {
      background: #f7f7fa;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 12px rgba(91,11,229,0.06);
    }
    .rental-form h2 {
      color: #5b0be5;
      margin-top: 0;
      font-size: 1.3em;
    }
    .form-group {
      margin-bottom: 14px;
    }
    .form-group label {
      font-weight: 600;
      margin-bottom: 5px;
      display: block;
      color: #222;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 1em;
      background: #fff;
      box-sizing: border-box;
    }
    .total-box {
      background: #f0f9ff;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 14px;
      font-weight: 600;
      color: #5b0be5;
    }
    .btn-primary {
      background: #5b0be5;
      color: #fff;
      border: none;
      padding: 12px 18px;
      cursor: pointer;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1em;
      width: 100%;
      transition: background 0.2s;
    }
    .btn-primary:hover {
      background: #3a087e;
    }
    .btn-back {
      background: #ccc;
      color: #333;
      border: none;
      padding: 10px 16px;
      cursor: pointer;
      border-radius: 6px;
      font-weight: bold;
      text-decoration: none;
      display: inline-block;
      margin-bottom: 20px;
      transition: background 0.2s;
    }
    .btn-back:hover {
      background: #bbb;
    }
    #rentMessage {
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      display: none;
      font-weight: 600;
    }
    @media (max-width: 768px) {
      main { padding: 16px; }
      .checkout-container { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <a href="index.html">Home</a> | <a href="rent.html">Rent</a>
  </header>

  <main>
    <a href="rent.html" class="btn-back">‚Üê Back to Bikes</a>
    
    <h1>Checkout</h1>

    <div class="checkout-container">
      <!-- Bike Summary -->
      <div class="bike-summary">
        <h2>Bike Details</h2>
        <div id="bikeSummary">Loading...</div>
      </div>

      <!-- Rental Form -->
      <div class="rental-form">
        <h2>Rental Details</h2>
        <form id="checkoutForm">
          <div class="form-group">
            <label>üë§ Renter</label>
            <input type="text" id="renterName" readonly>
          </div>
          <div class="form-group">
            <label>‚è∞ Rental Hours</label>
            <input type="number" id="rentHours" value="1" min="1" max="24" required onchange="updateCheckoutTotal()">
          </div>
          <div class="form-group">
            <label>üè∑Ô∏è Registration Number</label>
            <input type="text" id="regNumber" placeholder="ABC-123-456/2025" required>
          </div>
          <div class="total-box">
            üí∞ Total: KES <span id="checkoutTotal">0</span>
          </div>
          <div class="form-group">
            <label>üìû Mobile Provider</label>
            <select id="rentProvider" required>
              <option value="">Select Provider</option>
              <option>Safaricom</option>
              <option>Airtel</option>
              <option>T-Kash</option>
            </select>
          </div>
          <div class="form-group">
            <label>üì± Mobile Number</label>
            <input id="rentMobile" type="tel" placeholder="0712345678" pattern="^[0-9]{10}$" required>
          </div>
          <div class="form-group">
            <label>üîí Mobile PIN</label>
            <input id="rentPin" type="password" maxlength="6" placeholder="Your PIN" pattern="^[0-9]{4,6}$" required>
          </div>
          <button class="btn-primary" type="submit">‚úÖ Confirm & Pay</button>
          <div id="rentMessage"></div>
        </form>
      </div>
    </div>
  </main>

  <footer style="background-color: #5b0be5; color: #fff; padding: 14px; text-align: center; border-radius:0 0 16px 16px;">
    <p>&copy; 2025 MMU BikeRent. All rights reserved.</p>
  </footer>

  <script>
    // Block access if not logged in
    if (!localStorage.getItem('currentUser')) {
      alert('Please login or register to access rental services.');
      window.location.href = 'login.html';
    }

    // Get bike ID from URL parameter
    const params = new URLSearchParams(window.location.search);
    const bikeId = params.get('bikeId');

    if (!bikeId) {
      alert('No bike selected. Redirecting...');
      window.location.href = 'rent.html';
    }

    // Load bike details and populate checkout
    function loadCheckout() {
      const bikes = JSON.parse(localStorage.getItem('bikes') || '[]');
      const bike = bikes.find(b => b.id == bikeId);

      if (!bike) {
        alert('Bike not found. Redirecting...');
        window.location.href = 'rent.html';
        return;
      }

      const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');

      // Populate bike summary
      const bikeSummary = document.getElementById('bikeSummary');
      bikeSummary.innerHTML = `
        <div class="bike-image"><img src="${bike.image}" alt="${bike.name}" /></div>
        <div class="bike-details">
          <h3 style="margin: 0 0 8px 0">${bike.name}</h3>
          <p><strong>Type:</strong> ${bike.type}</p>
          <p><strong>Description:</strong> ${bike.description || 'N/A'}</p>
          <div class="bike-price">KES ${bike.price.toLocaleString()}/hour</div>
        </div>
      `;

      // Populate renter name
      document.getElementById('renterName').value = currentUser.fullname || '';

      // Set initial total
      updateCheckoutTotal();

      // Handle form submission
      const form = document.getElementById('checkoutForm');
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        processCheckout(bike, currentUser);
      });
    }

    function updateCheckoutTotal() {
      const bikes = JSON.parse(localStorage.getItem('bikes') || '[]');
      const bike = bikes.find(b => b.id == bikeId);
      const hours = Number(document.getElementById('rentHours').value) || 1;
      const total = bike.price * hours;
      document.getElementById('checkoutTotal').textContent = total.toLocaleString();
    }

    function processCheckout(bike, currentUser) {
      const hours = Number(document.getElementById('rentHours').value) || 1;
      const provider = document.getElementById('rentProvider').value;
      const mobile = document.getElementById('rentMobile').value.trim();
      const pin = document.getElementById('rentPin').value.trim();
      const regNumber = document.getElementById('regNumber').value.trim();
      const rentMessage = document.getElementById('rentMessage');

      const regNumberNorm = (regNumber || '').toUpperCase();
      const regRegex = /^[A-Z]{3}-\d{3}-\d{3}\/\d{4}$/;
      
      if (!regNumber || !regRegex.test(regNumberNorm)) {
        rentMessage.style.display = 'block';
        rentMessage.style.background = '#fee2e2';
        rentMessage.style.color = '#991b1b';
        rentMessage.textContent = '‚ùå Registration number must match format e.g. ABC-123-456/2025';
        return;
      }

      if (!provider) {
        rentMessage.style.display = 'block';
        rentMessage.style.background = '#fee2e2';
        rentMessage.style.color = '#991b1b';
        rentMessage.textContent = '‚ùå Please select a provider';
        return;
      }

      if (!/^\d{10}$/.test(mobile.replace(/\D/g, ''))) {
        rentMessage.style.display = 'block';
        rentMessage.style.background = '#fee2e2';
        rentMessage.style.color = '#991b1b';
        rentMessage.textContent = '‚ùå Invalid mobile number';
        return;
      }

      if (!/^\d{4,6}$/.test(pin)) {
        rentMessage.style.display = 'block';
        rentMessage.style.background = '#fee2e2';
        rentMessage.style.color = '#991b1b';
        rentMessage.textContent = '‚ùå PIN must be 4-6 digits';
        return;
      }

      const amount = bike.price * hours;
      rentMessage.style.display = 'block';
      rentMessage.style.background = '#0766e1ff';
      rentMessage.style.color = '#1e40af';
      rentMessage.textContent = '‚è≥ Processing payment...';

      // Simulate payment processing
      setTimeout(() => {
        if (pin === '0000') {
          rentMessage.style.background = '#fee2e2';
          rentMessage.style.color = '#991b1b';
          rentMessage.textContent = '‚ùå Invalid PIN. Please try again.';
          return;
        }

        const txId = 'TXN' + Math.floor(Math.random() * 900000 + 100000);
        const rentalId = 'RNT' + Date.now();

        // Save rental
        const rentals = JSON.parse(localStorage.getItem('rentals') || '[]');
        const startDate = new Date();
        const endDate = new Date(startDate.getTime() + hours * 3600000);
        
        rentals.push({
          id: rentalId,
          userName: currentUser.fullname,
          userEmail: currentUser.email,
          regNumber: regNumberNorm,
          bikeId: bike.id,
          bikeName: bike.name,
          hours,
          startDate: startDate.toISOString(),
          endDate: endDate.toISOString(),
          provider,
          mobile,
          paid: true,
          transactionId: txId
        });
        localStorage.setItem('rentals', JSON.stringify(rentals));

        // Update bike availability
        const bikes = JSON.parse(localStorage.getItem('bikes') || '[]');
        const idx = bikes.findIndex(b => b.id == bike.id);
        if (idx > -1) {
          bikes[idx].available = false;
          localStorage.setItem('bikes', JSON.stringify(bikes));
        }

        // Update user rentals count
        const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
        user.rentals = (user.rentals || 0) + 1;
        localStorage.setItem('currentUser', JSON.stringify(user));

        rentMessage.style.background = '#dcfce7';
        rentMessage.style.color = '#470fcbff';
        rentMessage.innerHTML = `‚úÖ Payment successful!<br>Transaction: <strong>${txId}</strong><br>Rental ID: <strong>${rentalId}</strong><br>Duration: <strong>${hours} hour(s)</strong>`;

        setTimeout(() => window.location.href = 'index.html', 3000);
      }, 1200);
    }

    // Load checkout on page load
    document.addEventListener('DOMContentLoaded', loadCheckout);
  </script>
</body>
</html>
