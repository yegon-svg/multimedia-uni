<DO!CTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Portal - MMU Bike Rental Hub</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body { font-family: Arial, Helvetica, sans-serif; background:#f4f6fa; margin:0; }
        .container { max-width: 1100px; margin: 32px auto; background:#fff; padding:20px 28px; border-radius:10px; box-shadow:0 6px 24px rgba(0,0,0,0.06); }
        h1,h2 { color:#5b0be5; margin:0 0 12px 0; }
        .cols { display:flex; gap:20px; }
        .col { flex:1; min-width:300px; }
        .btn { background:#5b0be5;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer }
        .btn.danger{background:#e55b0b}
        table { width:100%; border-collapse:collapse; margin-top:12px; }
        th,td{ padding:8px 10px; border:1px solid #eee; text-align:left; font-size:0.95rem; }
        th{ background:#f0eaff }
        .small { font-size:0.85rem; color:#666 }
        .actions button { margin-right:6px; }
        form.row { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
        form.row input, form.row select { padding:8px; border:1px solid #ddd; border-radius:6px; }
        .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
        .message { margin-top:8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div>
                <h1>Admin Portal</h1>
                <div class="small">Manage users and bicycles</div>
            </div>
            <div id="adminControls"></div>
        </div>

        <!-- AUTH SECTION -->
        <div id="authArea">
            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                <div style="min-width:320px; background:#fff; padding:16px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.03);">
                    <h2>Admin Login</h2>
                    <form id="adminLoginForm">
                        <input id="loginEmail" type="email" placeholder="Admin email" required style="width:100%;margin-bottom:8px;padding:8px;">
                        <input id="loginPassword" type="password" placeholder="Password" required style="width:100%;margin-bottom:8px;padding:8px;">
                        <button class="btn" type="submit">Login</button>
                    </form>
                    <p id="loginMessage" class="message" style="color:red"></p>
                </div>

                <div style="min-width:320px; background:#fff; padding:16px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.03);">
                    <h2>Create Admin</h2>
                    <form id="adminRegisterForm">
                        <input id="regEmail" type="email" placeholder="Email" required style="width:100%;margin-bottom:8px;padding:8px;">
                        <input id="regPassword" type="password" placeholder="Password" required style="width:100%;margin-bottom:8px;padding:8px;">
                        <button class="btn" type="submit">Register</button>
                    </form>
                    <p id="registerMessage" class="message" style="color:red"></p>
                </div>
            </div>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboard" style="display:none; margin-top:18px;">
            <!-- Admin Management Panel -->
            <div id="adminManagement" style="margin-bottom:16px; padding:12px; border:1px solid #f0f0f5; border-radius:8px; background:#fafafa;">
                <h2 style="margin:0 0 8px 0">Admins</h2>
                <div id="adminListContainer" class="small">Loading admins...</div>
            </div>

            <div style="display:flex; gap:20px; align-items:flex-start;">
                <div class="col">
                    <h2>Registered Users</h2>
                    <table id="userTable">
                        <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="col">
                    <h2>Bicycles</h2>

                    <!-- add bike form (updated to support image file upload + preview) -->
                    <form id="addBikeForm" class="row" enctype="multipart/form-data">
                        <input id="bikeName" placeholder="Name" required>
                        <input id="bikeType" placeholder="Type (e.g., Road)" required>
                        <input id="bikePrice" type="number" placeholder="Price/day" required>
                        
                        <!-- File input for image -->
                        <input id="bikeImageFile" type="file" accept="image/*" required>
                        <!-- Hidden input will hold the base64/dataURL to store in localStorage -->
                        <input id="bikeImage" type="hidden" value="">
                        <!-- Small preview -->
                        <div id="bikeImagePreview" style="width:60px; height:40px; border-radius:6px; overflow:hidden; display:inline-block; vertical-align:middle; background:#f0f0f0;">
                            <!-- preview inserted here -->
                        </div>

                        <select id="bikeAvail">
                            <option value="true">Available</option>
                            <option value="false">Not available</option>
                        </select>
                        <button class="btn" type="submit">Add Bike</button>
                    </form>
                    <p id="addBikeMessage" class="message" style="margin-top:8px; display:none;"></p>

                    <table id="bikesTable">
                        <thead><tr><th>Photo</th><th>Name</th><th>Type</th><th>Price</th><th>Available</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div style="margin-top:18px;">
                <h2>Recent Rentals</h2>
                <table id="rentalsTable">
                    <thead><tr><th>User</th><th>Bike</th><th>Days</th><th>Start</th><th>End</th><th>Provider</th><th>Mobile</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Access-denied overlay removed in favor of non-blocking notifications so non-admins can view the page. -->

    <!-- Toast container and modals -->
    <div id="toastContainer" style="position:fixed; top:16px; right:16px; z-index:10000; display:flex; flex-direction:column; gap:8px;"></div>

    <!-- Confirm modal -->
    <div id="confirmModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:10001;">
        <div style="background:#fff; padding:18px; border-radius:8px; max-width:420px; margin:auto; box-shadow:0 6px 20px rgba(0,0,0,0.15); text-align:center;">
            <p class="confirmMsg" style="margin:0 0 12px;"></p>
            <div style="display:flex; gap:12px; justify-content:center;">
                <button class="btn confirmYes">Confirm</button>
                <button class="btn confirmNo" style="background:#eee;color:#333">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Info modal -->
    <div id="infoModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:10002;">
        <div style="background:#fff; padding:18px; border-radius:8px; max-width:520px; margin:auto; box-shadow:0 6px 20px rgba(0,0,0,0.15); text-align:left;">
            <h3 id="infoModalTitle" style="margin-top:0"></h3>
            <div id="infoModalContent" style="margin-top:8px;"></div>
            <div style="text-align:right; margin-top:12px;"><button class="btn" id="infoModalClose">Close</button></div>
        </div>
    </div>

<script>
/* Admin auth and dashboard using localStorage */

/* ---------- utility storage helpers ---------- */
function getAdmins(){ return JSON.parse(localStorage.getItem('admins')||'[]'); }
function setAdmins(a){ localStorage.setItem('admins', JSON.stringify(a)); }
function getCurrentAdmin(){ return JSON.parse(localStorage.getItem('currentAdmin')||'null'); }
function setCurrentAdmin(a){ localStorage.setItem('currentAdmin', JSON.stringify(a)); }
function clearCurrentAdmin(){ localStorage.removeItem('currentAdmin'); }

// Helper to get logged-in regular user (if any)
function getCurrentUser(){ return JSON.parse(localStorage.getItem('currentUser')||'null'); }

// Preserved initial admins helpers
function getInitialAdmins(){ return JSON.parse(localStorage.getItem('initialAdmins')||'[]'); }
function resetInitialAdmins(){ localStorage.removeItem('initialAdmins'); }

// Check whether a given email is an admin
function isEmailAdmin(email){ const admins = getAdmins() || []; return admins.some(a => (a.email||'').toLowerCase() === (email||'').toLowerCase()); }

// Quick check whether current user is an admin (either via currentAdmin or logged-in user email)
function isCurrentUserAdmin(){ const curAdmin = getCurrentAdmin(); if (curAdmin) return true; const u = getCurrentUser(); if (!u) return false; return isEmailAdmin(u.email); }

// Guard to protect admin actions
function requireAdmin(){ 
    const curAdmin = getCurrentAdmin(); 
    const u = getCurrentUser(); 
    // allow if a current admin session is set
    if (curAdmin) return true; 
    // allow if the logged-in user is an admin
    if (u && isEmailAdmin(u.email)) return true; 
    // Notify and prevent the action (do not block the entire page)
    showNotification('Admin action requires admin privileges','error'); 
    return false; 
} 

function showAccessDenied(message){
    // Non-blocking: show a warning notification instead of redirecting or blocking the UI
    showNotification(message || 'Admin access required','warning');
} 

// Simple toast/notification
function showNotification(message, type='info'){
    const c = document.getElementById('toastContainer');
    if (!c) return alert(message); // fallback
    const el = document.createElement('div');
    el.textContent = message;
    el.style.padding = '8px 12px';
    el.style.borderRadius = '6px';
    el.style.color = '#fff';
    el.style.boxShadow = '0 4px 10px rgba(0,0,0,0.12)';
    el.style.opacity = '1';
    el.style.transition = 'opacity 0.3s';
    if (type === 'success') el.style.background = '#2e7d32';
    else if (type === 'error') el.style.background = '#c62828';
    else if (type === 'warning') el.style.background = '#f9a825';
    else el.style.background = '#1976d2';
    c.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=> el.remove(), 300); }, 3000);
}

// Confirm dialog returns a Promise<boolean>
function showConfirm(message){
    return new Promise(resolve=>{
        const cm = document.getElementById('confirmModal');
        if (!cm) { resolve(confirm(message)); return; }
        const msgEl = cm.querySelector('.confirmMsg');
        msgEl.textContent = message;
        cm.style.display = 'flex';
        const yes = cm.querySelector('.confirmYes');
        const no = cm.querySelector('.confirmNo');
        function cleanup(){
            yes.removeEventListener('click', yesHandler);
            no.removeEventListener('click', noHandler);
            cm.style.display = 'none';
        }
        function yesHandler(){ cleanup(); resolve(true); }
        function noHandler(){ cleanup(); resolve(false); }
        yes.addEventListener('click', yesHandler);
        no.addEventListener('click', noHandler);
    });
}

// Info modal for displaying content
function showModal(title, htmlContent){
    const m = document.getElementById('infoModal');
    const t = document.getElementById('infoModalTitle');
    const c = document.getElementById('infoModalContent');
    if (!m) { alert(title + '\n' + htmlContent); return; }
    t.textContent = title || '';
    c.innerHTML = htmlContent || '';
    m.style.display = 'flex';
}
document.getElementById('infoModalClose')?.addEventListener('click', ()=> {
    const m = document.getElementById('infoModal'); if (m) m.style.display = 'none';
});

// Enforce admin policy: only the first two registered users OR the initially registered admins may be admins
// This version preserves initially registered admins (saved to localStorage.initialAdmins) and prompts the current admin for confirmation before revoking any extra admins.
async function enforceAdminPolicy(){
    const users = JSON.parse(localStorage.getItem('users')||'[]');
    // Sort by createdAt if present, otherwise keep array order
    users.sort((a,b)=>{
        const ta = a.createdAt ? new Date(a.createdAt).getTime() : 0;
        const tb = b.createdAt ? new Date(b.createdAt).getTime() : 0;
        return ta - tb;
    });
    const allowed = users.slice(0,2).map(u => (u.email||'').toLowerCase());

    let admins = JSON.parse(localStorage.getItem('admins')||'[]');

    // Initialize preserved initial admins if not present
    let initialAdmins = JSON.parse(localStorage.getItem('initialAdmins')||'[]').map(e=> (e||'').toLowerCase());
    if (!initialAdmins.length) {
        initialAdmins = admins.map(a => (a.email||'').toLowerCase());
        if (initialAdmins.length) localStorage.setItem('initialAdmins', JSON.stringify(initialAdmins));
    }

    // Determine which admins would be revoked (not in allowed set and not an initial admin)
    const toRevoke = admins.filter(a => {
        const e = (a.email||'').toLowerCase();
        return !(allowed.includes(e) || initialAdmins.includes(e));
    });

    if (!toRevoke.length) return; // nothing to do

    // Prefer current admin session, otherwise a logged-in admin user can confirm
    const cur = getCurrentAdmin();
    const user = getCurrentUser();
    const userIsAdmin = user && isEmailAdmin(user.email);

    // If there's no admin present to confirm, do not auto-revoke; notify instead
    if (!cur && !userIsAdmin) {
        showNotification('Admin policy violation detected. Sign in as an admin to review pending revocations.','warning');
        return;
    }

    // Build message listing accounts to be revoked
    const list = toRevoke.map(a=>`- ${a.email}`).join('\n');
    const message = `The following admin accounts are neither initial admins nor among the first two registered users and will be revoked if you confirm:\n\n${list}\n\nProceed to revoke them now?`;

    const confirmed = await showConfirm(message);
    if (!confirmed) {
        showNotification('Revocation cancelled','info');
        return;
    }

    const filtered = admins.filter(a => {
        const e = (a.email||'').toLowerCase();
        return (allowed.includes(e) || initialAdmins.includes(e));
    });
    localStorage.setItem('admins', JSON.stringify(filtered));

    // If current admin lost access, revoke and redirect
    const current = getCurrentAdmin();
    if (current && !filtered.find(a => (a.email||'').toLowerCase() === (current.email||'').toLowerCase())){
        clearCurrentAdmin();
        showNotification('Your admin access has been revoked','error');
        setTimeout(()=>{ window.location.href = 'index.html'; }, 1500);
        return;
    }

    showNotification('Selected admins revoked successfully','success');
}


/* seed sample bikes if none */
function seedBikes(){
    const existing = JSON.parse(localStorage.getItem('bikes')||'[]');
    if(existing.length) return;
    const sample = [
        {id:1,name:'Mountain Bike',type:'Mountain',price:500,image:'images/mountain-bike-2.jpeg',available:true},
        {id:2,name:'Road Bike',type:'Road',price:800,image:'images/road-bike-1.jpeg',available:true},
        {id:3,name:'Electric Bike',type:'E-Bike',price:1500,image:'images/electric-22.jpeg',available:true},
        {id:4,name:'Hybrid Bike',type:'Hybrid',price:1000,image:'images/hybrid-d.jpeg',available:true}
    ];
    localStorage.setItem('bikes', JSON.stringify(sample));
}
seedBikes();

// Disable admin registration form if admin limit (2) is reached
(function() {
    const form = document.getElementById('adminRegisterForm');
    const msg = document.getElementById('registerMessage');
    const admins = getAdmins();
    if (admins && admins.length >= 2) {
        if (form) Array.from(form.elements).forEach(el => el.disabled = true);
        if (msg) { msg.style.color = 'red'; msg.textContent = 'Admin registrations are closed (max 2 admins).'; }
    }
})();

/* ---------- AUTH HANDLERS ---------- */
document.getElementById('adminRegisterForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const email = document.getElementById('regEmail').value.trim().toLowerCase();
    const pw = document.getElementById('regPassword').value;
    const admins = getAdmins();
    if (admins && admins.length >= 2) { document.getElementById('registerMessage').style.color = 'red'; document.getElementById('registerMessage').textContent = 'Admin limit reached (max 2).'; return; }
    if(admins.find(a=>a.email===email)){ document.getElementById('registerMessage').textContent='Email already registered.'; return; }
    admins.push({email, password: btoa(pw)});
    setAdmins(admins);
    // Enforce policy in case this registration exceeds the allowed admins
    enforceAdminPolicy().catch(e => console.warn('enforceAdminPolicy failed', e));
    document.getElementById('registerMessage').style.color='green';
    document.getElementById('registerMessage').textContent='Admin created. You can login.';
    setTimeout(()=>{ document.getElementById('registerMessage').textContent=''; }, 2000);
});

document.getElementById('adminLoginForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const email = document.getElementById('loginEmail').value.trim().toLowerCase();
    const pw = document.getElementById('loginPassword').value;
    const admin = getAdmins().find(a=>a.email===email);
    let storedPw;
    try { storedPw = admin && atob(admin.password); } catch (err) { storedPw = admin && admin.password; }
    if(!admin || storedPw !== pw){ document.getElementById('loginMessage').textContent='Invalid credentials.'; return; }
    setCurrentAdmin({email});
    showDashboard();
});

/* ---------- UI & Dashboard ---------- */
const authArea = document.getElementById('authArea');
const dashboard = document.getElementById('dashboard');
const adminControls = document.getElementById('adminControls');

function showDashboard(){
    authArea.style.display='none';
    dashboard.style.display='block';
    renderAdminControls();
    loadDashboardData();
}
function showAuth(){
    authArea.style.display='block';
    dashboard.style.display='none';
    adminControls.innerHTML='';
}

/* render top controls when logged in */
function renderAdminControls(){
    const admin = getCurrentAdmin();
    if(!admin){ adminControls.innerHTML=''; return; }
    adminControls.innerHTML = `<div class="small">Signed in: ${admin.email}</div>
        <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn" id="refreshBtn">Refresh</button>
            <button class="btn danger" id="logoutBtn">Logout</button>
        </div>`;
    document.getElementById('logoutBtn').addEventListener('click', ()=>{ clearCurrentAdmin(); showAuth(); });
    document.getElementById('refreshBtn').addEventListener('click', loadDashboardData);
}

/* ---------- load tables ---------- */
function loadDashboardData(){
    // users
    const users = JSON.parse(localStorage.getItem('users')||'[]');
    const userTbody = document.querySelector('#userTable tbody');
    userTbody.innerHTML = users.map(u=>`
        <tr>
            <td>${u.fullname||''}</td>
            <td>${u.email||''}</td>
            <td>${u.phone||''}</td>
            <td class="actions">
                <button class="btn" onclick="viewUser('${u.email}')">View</button>
                <button class="btn danger" onclick="deleteUser('${u.email}')">Delete</button>
            </td>
        </tr>
    `).join('') || '<tr><td colspan="4" class="small">No users registered</td></tr>';

    // bikes
    const bikes = JSON.parse(localStorage.getItem('bikes')||'[]');
    const bikesTbody = document.querySelector('#bikesTable tbody');
    bikesTbody.innerHTML = bikes.map(b=>`
        <tr data-id="${b.id}">
            <td><img src="${b.image}" alt="${b.name}" style="width:60px;height:40px;object-fit:cover;border-radius:6px"></td>
            <td>${b.name}</td>
            <td>${b.type}</td>
            <td>KES ${b.price}</td>
            <td>${b.available? 'Yes' : 'No'}</td>
            <td class="actions">
                <button class="btn" onclick="toggleBike(${b.id})">${b.available? 'Mark Not Available':'Mark Available'}</button>
                <button class="btn" onclick="editBike(${b.id})">Edit</button>
                <button class="btn danger" onclick="deleteBike(${b.id})">Delete</button>
            </td>
        </tr>
    `).join('') || '<tr><td colspan="6" class="small">No bikes</td></tr>';

    // rentals
    const rentals = JSON.parse(localStorage.getItem('rentals')||'[]');
    const rentTbody = document.querySelector('#rentalsTable tbody');
    rentTbody.innerHTML = rentals.map(r=>`
        <tr>
            <td>${r.userName||''}</td>
            <td>${r.bikeName||''}</td>
            <td>${r.days||''}</td>
            <td>${r.startDate||''}</td>
            <td>${r.endDate||''}</td>
            <td>${r.provider||''}</td>
            <td>${r.mobile||''}</td>
        </tr>
    `).join('') || '<tr><td colspan="7" class="small">No rentals yet</td></tr>';

    // refresh admin management panel
    try { renderAdminManagement(); } catch (e) { console.warn('renderAdminManagement failed', e); }
}

/* ---------- Admin management (UI & actions) ---------- */

function renderAdminManagement(){
    const container = document.getElementById('adminListContainer');
    if (!container) return;
    const admins = JSON.parse(localStorage.getItem('admins')||'[]');
    let html = '<table><thead><tr><th>Email</th><th style="width:180px">Actions</th></tr></thead><tbody>';
    if (admins.length) {
        html += admins.map(a => `
            <tr>
                <td>${a.email}</td>
                <td>
                    <button class="btn" onclick="revokeAdmin('${a.email}')">Revoke</button>
                </td>
            </tr>
        `).join('');
    } else {
        html += '<tr><td colspan="2" class="small">No admins defined</td></tr>';
    }
    html += '</tbody></table>';

    // Promote control
    const users = JSON.parse(localStorage.getItem('users')||'[]');
    const candidates = users.filter(u => !admins.some(ad => (ad.email||'').toLowerCase() === (u.email||'').toLowerCase()));
    if (admins.length < 2) {
        if (candidates.length) {
            html += `<div style="margin-top:8px">Promote user to admin: <select id="promoteSelect">${candidates.map(u=>`<option value="${u.email}">${u.fullname||u.email}</option>`).join('')}</select> <button class="btn" id="promoteBtn">Promote</button></div>`;
        } else {
            html += '<div style="margin-top:8px" class="small"><em>No eligible users to promote</em></div>';
        }
    } else {
        html += '<div style="margin-top:8px" class="small"><em>Admin limit reached (max 2)</em></div>';
    }

    container.innerHTML = html;

    const promoteBtn = document.getElementById('promoteBtn');
    if (promoteBtn) promoteBtn.addEventListener('click', ()=>{
        const sel = document.getElementById('promoteSelect');
        if (sel && sel.value) promoteUserToAdmin(sel.value);
    });

    // Wire up preserved initial admins area
    const resetBtn = document.getElementById('resetInitialAdminsBtn');
    if (resetBtn) resetBtn.addEventListener('click', async ()=>{
        const confirmed = await showConfirm('Reset preserved initial admins? This will allow policy enforcement to consider them for revocation. Continue?');
        if (!confirmed) return;
        resetInitialAdmins();
        showNotification('Preserved initial admins reset','success');
        // Re-run enforcement to apply potential revocations (enforceAdminPolicy prompts for confirmation if needed)
        try { await enforceAdminPolicy(); } catch (e) { console.warn('enforceAdminPolicy failed', e); }
        renderAdminManagement();
    });
}

function revokeAdmin(email){
    if(!requireAdmin()) return;
    let admins = JSON.parse(localStorage.getItem('admins')||'[]');
    if (!admins.find(a=>a.email===email)) { showNotification('Admin not found','error'); return; }
    if (admins.length <= 1) { showNotification('Cannot remove the last admin','error'); return; }
    showConfirm(`Revoke admin privileges for ${email}?`).then(confirmed => {
        if (!confirmed) return;
        admins = admins.filter(a=>a.email!==email);
        localStorage.setItem('admins', JSON.stringify(admins));
        const cur = getCurrentAdmin();
        if (cur && cur.email === email) { clearCurrentAdmin(); showAuth(); showNotification('You revoked your own admin rights and were logged out.','info'); setTimeout(()=>{ window.location.href = 'index.html'; }, 1500); return; }
        renderAdminManagement();
        loadDashboardData();
        showNotification('Admin revoked','success');
    });
}

function promoteUserToAdmin(email){
    if(!requireAdmin()) return;
    const admins = JSON.parse(localStorage.getItem('admins')||'[]');
    if (admins.length >= 2) { showNotification('Admin limit reached','error'); return; }
    const users = JSON.parse(localStorage.getItem('users')||'[]');
    const u = users.find(x=>x.email===email);
    if (!u) { showNotification('User not found','error'); return; }
    if (admins.find(a=>a.email===u.email)) { showNotification('User is already an admin','warning'); return; }
    admins.push({ email: u.email, password: u.password });
    localStorage.setItem('admins', JSON.stringify(admins));
    // Enforce policy after promotion
    enforceAdminPolicy().catch(e => console.warn('enforceAdminPolicy failed', e));
    renderAdminManagement();
    loadDashboardData();
    showNotification('User promoted to admin','success');
}

/* ---------- user actions ---------- */
window.viewUser = function(email){
    if(!requireAdmin()) return;
    const users = JSON.parse(localStorage.getItem('users')||'[]');
    const u = users.find(x=>x.email===email);
    if(!u) { showNotification('User not found','error'); return; }
    const html = `<p><strong>Name:</strong> ${u.fullname||''}</p><p><strong>Email:</strong> ${u.email||''}</p><p><strong>Phone:</strong> ${u.phone||''}</p>`;
    showModal('User details', html);
};

window.deleteUser = function(email){
    if(!requireAdmin()) return;
    showConfirm('Delete user and their rentals?').then(confirmed => {
        if(!confirmed) return;
        let users = JSON.parse(localStorage.getItem('users')||'[]');
        users = users.filter(u=>u.email!==email);
        localStorage.setItem('users', JSON.stringify(users));
        // remove rentals by user
        let rentals = JSON.parse(localStorage.getItem('rentals')||'[]');
        rentals = rentals.filter(r=> r.userEmail !== email);
        localStorage.setItem('rentals', JSON.stringify(rentals));
        loadDashboardData();
        showNotification('User deleted','success');
    });
};

// Bike actions (single guarded implementation)
// Uses the image input (base64/data URL) set by the file-reader above
// Add bike is handled above (image-upload handler) so we only include toggle/delete/edit here
window.toggleBike = function(id){
    if(!requireAdmin()) return;
    const bikes = JSON.parse(localStorage.getItem('bikes')||'[]');
    const idx = bikes.findIndex(b=>b.id===id);
    if(idx===-1) return;
    bikes[idx].available = !bikes[idx].available;
    localStorage.setItem('bikes', JSON.stringify(bikes));
    loadDashboardData();
};

window.deleteBike = function(id){
    if(!requireAdmin()) return;
    showConfirm('Delete this bike?').then(confirmed => {
        if(!confirmed) return;
        let bikes = JSON.parse(localStorage.getItem('bikes')||'[]');
        bikes = bikes.filter(b=>b.id!==id);
        localStorage.setItem('bikes', JSON.stringify(bikes));
        loadDashboardData();
        showNotification('Bike deleted','success');
    });
};

window.editBike = function(id){
    if(!requireAdmin()) return;
    const bikes = JSON.parse(localStorage.getItem('bikes')||'[]');
    const bike = bikes.find(b=>b.id===id);
    if(!bike) return;
    const name = prompt('Name:', bike.name);
    if(!name) return;
    const type = prompt('Type:', bike.type) || bike.type;
    const price = parseFloat(prompt('Price/day:', bike.price) || bike.price);
    const image = prompt('Image path:', bike.image) || bike.image;
    bike.name = name; bike.type = type; bike.price = price; bike.image = image;
    localStorage.setItem('bikes', JSON.stringify(bikes));
    loadDashboardData();
};

/* ---------- image upload preview and bike form handler ---------- */
document.addEventListener('DOMContentLoaded', function() {
    const bikeImageFileInput = document.getElementById('bikeImageFile');
    const bikeImageHidden = document.getElementById('bikeImage');
    const bikeImagePreview = document.getElementById('bikeImagePreview');
    const addBikeForm = document.getElementById('addBikeForm');
    const addBikeMessage = document.getElementById('addBikeMessage');

    // read file and set hidden input + preview
    bikeImageFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) {
            bikeImageHidden.value = '';
            bikeImagePreview.innerHTML = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = function(evt) {
            // store base64/data URL
            bikeImageHidden.value = evt.target.result;
            // show preview
            bikeImagePreview.innerHTML = `<img src="${evt.target.result}" style="width:100%; height:100%; object-fit:cover;">`;
        };
        reader.readAsDataURL(file);
    });

    // Add bike (stores image data URL)
    addBikeForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        if (!requireAdmin()) return;
        const name = document.getElementById('bikeName').value.trim();
        const type = document.getElementById('bikeType').value.trim();
        const price = Number(document.getElementById('bikePrice').value);
        // image may be a data URL stored in hidden input
        const image = document.getElementById('bikeImage').value.trim();
        const available = document.getElementById('bikeAvail').value === 'true';

        if (!name || !type || !price) {
            addBikeMessage.style.display = 'block';
            addBikeMessage.style.color = 'red';
            addBikeMessage.textContent = 'Please fill in all fields.';
            return;
        }

        if (!image) {
            addBikeMessage.style.display = 'block';
            addBikeMessage.style.color = 'red';
            addBikeMessage.textContent = 'Please select an image for the bike.';
            return;
        }

        const bikes = JSON.parse(localStorage.getItem('bikes')||'[]');
        const id = bikes.length ? Math.max(...bikes.map(b=>b.id))+1 : 1;
        bikes.push({id, name, type, price, image, available});
        localStorage.setItem('bikes', JSON.stringify(bikes));
        
        // Show success message
        addBikeMessage.style.display = 'block';
        addBikeMessage.style.color = 'green';
        addBikeMessage.textContent = `Bike "${name}" added successfully!`;
        
        // Reset form
        addBikeForm.reset();
        bikeImageHidden.value = '';
        bikeImagePreview.innerHTML = '';
        
        // Reload dashboard
        loadDashboardData();
        
        // Clear message after 2 seconds
        setTimeout(() => {
            addBikeMessage.style.display = 'none';
            addBikeMessage.textContent = '';
        }, 2000);
    });
});

/* ---------- init on load ---------- */
window.addEventListener('load', async ()=>{
    // Ensure admin policy is enforced as early as possible (may prompt for confirmation)
    try { await enforceAdminPolicy(); } catch (e) { console.warn('enforceAdminPolicy failed', e); }

    const current = getCurrentAdmin();
    const user = getCurrentUser();
    const userIsAdmin = user && isEmailAdmin(user.email);

    // If logged-in user is an admin but not yet set as currentAdmin, set it for convenience and show dashboard
    if (userIsAdmin && !current) {
        setCurrentAdmin({ email: user.email });
        showDashboard();
        return;
    }

    // If there's an existing admin session, show the dashboard
    if (current) { showDashboard(); return; }

    // No admin signed in: keep the auth area visible so admins can log in, but allow others to view the page
    showAuth();
});
</script>
</body>
</html>

      



